openapi: 3.0.3
info:
  title: Saturn MouseHunter ä»£ç†æ± æœåŠ¡ API
  description: |
    Saturn MouseHunter ä»£ç†æ± è½®æ¢å¾®æœåŠ¡çš„å®Œæ•´ API è§„èŒƒã€‚

    æ”¯æŒå¤šå¸‚åœºï¼ˆCN/HK/USï¼‰ä»£ç†æ± ç®¡ç†ï¼ŒåŒ…æ‹¬è‡ªåŠ¨è°ƒåº¦ã€æ™ºèƒ½è½®æ¢å’Œå…¨é¢ç›‘æ§ã€‚

    ## æ ¸å¿ƒåŠŸèƒ½
    - ğŸŒ å¤šå¸‚åœºæ”¯æŒ: CN/HK/USä¸‰ä¸ªå¸‚åœº
    - ğŸ”„ æ™ºèƒ½è½®æ¢: A/BåŒæ± 7åˆ†é’Ÿè‡ªåŠ¨è½®æ¢
    - â° è‡ªåŠ¨è°ƒåº¦: ç›˜å‰2åˆ†é’Ÿå¯åŠ¨ï¼Œç›˜åè‡ªåŠ¨åœæ­¢
    - ğŸ“Š ç›‘æ§å‘Šè­¦: å®æ—¶å¥åº·æ£€æŸ¥å’Œå¤šçº§åˆ«å‘Šè­¦

    ## ä½¿ç”¨æµç¨‹
    1. è°ƒç”¨ `/api/v1/rpc` è·å–ä»£ç†åœ°å€
    2. ä½¿ç”¨ä»£ç†è¿›è¡Œæ•°æ®è¯·æ±‚
    3. å¦‚æœä»£ç†å¤±è´¥ï¼Œè°ƒç”¨ `/api/v1/rpc` æŠ¥å‘Šå¤±è´¥
    4. å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€ç¡®ä¿æœåŠ¡æ­£å¸¸

  version: 1.0.0
  contact:
    name: Saturn MouseHunter Team
    email: support@saturn.com
  license:
    name: MIT

servers:
  - url: http://192.168.8.168:8005
    description: å¼€å‘ç¯å¢ƒ
  - url: http://proxy-pool-test.saturn.com:8005
    description: æµ‹è¯•ç¯å¢ƒ
  - url: http://proxy-pool.saturn.com:8005
    description: ç”Ÿäº§ç¯å¢ƒ

tags:
  - name: RPC
    description: RPCé£æ ¼çš„æ ¸å¿ƒä»£ç†æ± æ¥å£
  - name: Pool Management
    description: ä»£ç†æ± ç®¡ç†å’ŒçŠ¶æ€æŸ¥è¯¢
  - name: Configuration
    description: é…ç½®ç®¡ç†
  - name: Monitoring
    description: ç›‘æ§å’Œå‘Šè­¦
  - name: Scheduler
    description: è°ƒåº¦ç®¡ç†

paths:
  /api/v1/rpc:
    post:
      tags: [RPC]
      summary: RPCæ¥å£ - æ ¸å¿ƒä»£ç†æ± æ“ä½œ
      description: |
        ç»Ÿä¸€çš„RPCæ¥å£ï¼Œæ”¯æŒä»¥ä¸‹æ“ä½œï¼š
        - `get_proxy`: è·å–å¯ç”¨ä»£ç†ï¼ˆæœ€å¸¸ç”¨ï¼‰
        - `report_failure`: æŠ¥å‘Šä»£ç†å¤±è´¥ï¼ˆå¿…é¡»è°ƒç”¨ï¼‰
        - `ping`: å¥åº·æ£€æŸ¥
        - `get_status`: è·å–çŠ¶æ€
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RpcRequest'
            examples:
              get_proxy:
                summary: è·å–ä»£ç†
                value:
                  event: "get_proxy"
                  market: "hk"
                  mode: "live"
                  proxy_type: "short"
              report_failure:
                summary: æŠ¥å‘Šå¤±è´¥
                value:
                  event: "report_failure"
                  market: "hk"
                  mode: "live"
                  proxy_addr: "192.168.1.100:8005"
              ping:
                summary: å¥åº·æ£€æŸ¥
                value:
                  event: "ping"
                  market: "hk"
                  mode: "live"
      responses:
        '200':
          description: æ“ä½œæˆåŠŸ
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ProxyResponse'
                  - $ref: '#/components/schemas/FailureResponse'
                  - $ref: '#/components/schemas/PingResponse'
                  - $ref: '#/components/schemas/StatusRpcResponse'
              examples:
                proxy_success:
                  summary: è·å–ä»£ç†æˆåŠŸ
                  value:
                    status: "ok"
                    proxy: "192.168.1.100:8005"
                failure_reported:
                  summary: å¤±è´¥æŠ¥å‘ŠæˆåŠŸ
                  value:
                    status: "ok"
                    message: "192.168.1.100:8005 marked as failure"
                ping_success:
                  summary: å¥åº·æ£€æŸ¥æˆåŠŸ
                  value:
                    status: "ok"
                    message: "pong"
                    market: "hk"
                    mode: "live"
                    running: true
                    market_status: "market_open"
        '400':
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: ä»£ç†æ± ä¸å­˜åœ¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/pools:
    get:
      tags: [Pool Management]
      summary: è·å–æ‰€æœ‰ä»£ç†æ± çŠ¶æ€
      description: è¿”å›æ‰€æœ‰å¸‚åœºå’Œæ¨¡å¼çš„ä»£ç†æ± çŠ¶æ€ä¿¡æ¯
      responses:
        '200':
          description: æˆåŠŸè·å–ä»£ç†æ± åˆ—è¡¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolsResponse'

  /api/v1/status:
    get:
      tags: [Pool Management]
      summary: è·å–ç‰¹å®šä»£ç†æ± çŠ¶æ€
      description: è·å–æŒ‡å®šå¸‚åœºå’Œæ¨¡å¼çš„ä»£ç†æ± è¯¦ç»†çŠ¶æ€
      parameters:
        - name: market
          in: query
          required: true
          schema:
            type: string
            enum: [cn, hk, us]
          description: å¸‚åœºä»£ç 
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [live, backfill]
            default: live
          description: è¿è¡Œæ¨¡å¼
      responses:
        '200':
          description: æˆåŠŸè·å–çŠ¶æ€
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  /api/v1/metrics:
    get:
      tags: [Pool Management]
      summary: è·å–ä»£ç†æ± æŒ‡æ ‡
      description: è·å–æŒ‡å®šä»£ç†æ± çš„æ€§èƒ½æŒ‡æ ‡æ•°æ®
      parameters:
        - name: market
          in: query
          required: true
          schema:
            type: string
            enum: [cn, hk, us]
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [live, backfill]
            default: live
      responses:
        '200':
          description: æˆåŠŸè·å–æŒ‡æ ‡
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /api/v1/start:
    post:
      tags: [Pool Management]
      summary: å¯åŠ¨ä»£ç†æ± 
      description: æ‰‹åŠ¨å¯åŠ¨æŒ‡å®šå¸‚åœºçš„ä»£ç†æ± æœåŠ¡
      parameters:
        - name: market
          in: query
          required: true
          schema:
            type: string
            enum: [cn, hk, us]
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [live, backfill]
            default: live
      responses:
        '200':
          description: å¯åŠ¨æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'

  /api/v1/stop:
    post:
      tags: [Pool Management]
      summary: åœæ­¢ä»£ç†æ± 
      description: æ‰‹åŠ¨åœæ­¢æŒ‡å®šå¸‚åœºçš„ä»£ç†æ± æœåŠ¡
      parameters:
        - name: market
          in: query
          required: true
          schema:
            type: string
            enum: [cn, hk, us]
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [live, backfill]
            default: live
      responses:
        '200':
          description: åœæ­¢æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'

  /api/v1/config:
    get:
      tags: [Configuration]
      summary: è·å–é…ç½®
      description: è·å–æŒ‡å®šä»£ç†æ± çš„é…ç½®ä¿¡æ¯
      parameters:
        - name: market
          in: query
          required: true
          schema:
            type: string
            enum: [cn, hk, us]
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [live, backfill]
            default: live
      responses:
        '200':
          description: é…ç½®è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

    post:
      tags: [Configuration]
      summary: æ›´æ–°é…ç½®
      description: æ›´æ–°æŒ‡å®šä»£ç†æ± çš„é…ç½®å‚æ•°
      parameters:
        - name: market
          in: query
          required: true
          schema:
            type: string
            enum: [cn, hk, us]
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [live, backfill]
            default: live
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigUpdateRequest'
      responses:
        '200':
          description: é…ç½®æ›´æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigUpdateResponse'

  /api/v1/monitoring/alerts:
    get:
      tags: [Monitoring]
      summary: è·å–å‘Šè­¦åˆ—è¡¨
      description: è·å–ç³»ç»Ÿå‘Šè­¦ä¿¡æ¯ï¼Œæ”¯æŒæ—¶é—´å’Œçº§åˆ«è¿‡æ»¤
      parameters:
        - name: hours
          in: query
          schema:
            type: integer
            default: 24
          description: è·å–å¤šå°‘å°æ—¶å†…çš„å‘Šè­¦
        - name: level
          in: query
          schema:
            type: string
            enum: [info, warning, error, critical]
          description: å‘Šè­¦çº§åˆ«è¿‡æ»¤
        - name: market
          in: query
          schema:
            type: string
            enum: [cn, hk, us]
          description: å¸‚åœºè¿‡æ»¤
      responses:
        '200':
          description: æˆåŠŸè·å–å‘Šè­¦åˆ—è¡¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'

  /api/v1/monitoring/summary:
    get:
      tags: [Monitoring]
      summary: è·å–ç›‘æ§æ‘˜è¦
      description: è·å–ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦çš„æ‘˜è¦ä¿¡æ¯
      responses:
        '200':
          description: æˆåŠŸè·å–ç›‘æ§æ‘˜è¦
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonitoringSummaryResponse'

  /api/v1/scheduler/status:
    get:
      tags: [Scheduler]
      summary: è·å–è°ƒåº¦å™¨çŠ¶æ€
      description: è·å–å…¨å±€è°ƒåº¦å™¨çš„è¿è¡ŒçŠ¶æ€å’Œå„å¸‚åœºè°ƒåº¦ä¿¡æ¯
      responses:
        '200':
          description: æˆåŠŸè·å–è°ƒåº¦å™¨çŠ¶æ€
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchedulerStatusResponse'

  /health:
    get:
      tags: [System]
      summary: ç³»ç»Ÿå¥åº·æ£€æŸ¥
      description: æ£€æŸ¥ç³»ç»Ÿæ•´ä½“å¥åº·çŠ¶æ€
      responses:
        '200':
          description: ç³»ç»Ÿå¥åº·
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

components:
  schemas:
    # RPC è¯·æ±‚/å“åº”æ¨¡å‹
    RpcRequest:
      type: object
      required: [event]
      properties:
        event:
          type: string
          enum: [get_proxy, report_failure, ping, get_status]
          description: æ“ä½œç±»å‹
        market:
          type: string
          enum: [cn, hk, us]
          default: hk
          description: å¸‚åœºä»£ç 
        mode:
          type: string
          enum: [live, backfill]
          default: live
          description: è¿è¡Œæ¨¡å¼
        proxy_type:
          type: string
          default: short
          description: ä»£ç†ç±»å‹ï¼ˆç”¨äºget_proxyï¼‰
        proxy_addr:
          type: string
          description: ä»£ç†åœ°å€ï¼ˆç”¨äºreport_failureï¼‰

    ProxyResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        proxy:
          type: string
          nullable: true
          description: ä»£ç†åœ°å€ï¼Œæ ¼å¼ä¸º IP:PORT

    FailureResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        message:
          type: string

    PingResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        message:
          type: string
        market:
          type: string
        mode:
          type: string
        running:
          type: boolean
        market_status:
          type: string
          enum: [market_open, market_closed, pre_market, after_market]

    StatusRpcResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        stats:
          $ref: '#/components/schemas/PoolStats'
        market_status:
          type: string
        service_mode:
          type: string

    # ä»£ç†æ± çŠ¶æ€æ¨¡å‹
    PoolsResponse:
      type: object
      properties:
        pools:
          type: array
          items:
            $ref: '#/components/schemas/PoolInfo'

    PoolInfo:
      type: object
      properties:
        key:
          type: string
          description: ä»£ç†æ± æ ‡è¯†ï¼Œå¦‚ "hk_live"
        market:
          type: string
          enum: [cn, hk, us]
        mode:
          type: string
          enum: [live, backfill]
        running:
          type: boolean
        status:
          type: object
          properties:
            stats:
              $ref: '#/components/schemas/PoolStats'
            market_status:
              type: string

    StatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        running:
          type: boolean
        market:
          type: string
        mode:
          type: string
        market_status:
          type: string
          enum: [market_open, market_closed, pre_market, after_market]
        stats:
          $ref: '#/components/schemas/PoolStats'

    PoolStats:
      type: object
      properties:
        total_pool_size:
          type: integer
          description: æ€»ä»£ç†æ•°é‡
        success_rate:
          type: number
          format: float
          description: æˆåŠŸç‡ç™¾åˆ†æ¯” (0-100)
        active_pool:
          type: string
          enum: [A, B]
          description: å½“å‰æ´»è·ƒæ± 
        active_pool_size:
          type: integer
          description: æ´»è·ƒæ± å¤§å°
        standby_pool_size:
          type: integer
          description: å¤‡ç”¨æ± å¤§å°
        total_requests:
          type: integer
          format: int64
          description: æ€»è¯·æ±‚æ•°
        success_count:
          type: integer
          format: int64
          description: æˆåŠŸæ¬¡æ•°
        failure_count:
          type: integer
          format: int64
          description: å¤±è´¥æ¬¡æ•°

    MetricsResponse:
      type: object
      properties:
        running:
          type: integer
          enum: [0, 1]
          description: è¿è¡ŒçŠ¶æ€ (0=åœæ­¢, 1=è¿è¡Œ)
        active_pool:
          type: string
          enum: [A, B]
          nullable: true
        size_active:
          type: integer
        size_standby:
          type: integer
        total_pool_size:
          type: integer
        success_rate:
          type: number
          format: float
        total_requests:
          type: integer
          format: int64
        success_count:
          type: integer
          format: int64
        failure_count:
          type: integer
          format: int64

    # é…ç½®æ¨¡å‹
    ConfigResponse:
      type: object
      properties:
        market:
          type: string
        mode:
          type: string
        config:
          $ref: '#/components/schemas/ProxyPoolConfig'
        backend:
          type: string
          default: database_driven

    ProxyPoolConfig:
      type: object
      properties:
        hailiang_api_url:
          type: string
          description: æµ·é‡ä»£ç†APIåœ°å€
        hailiang_enabled:
          type: boolean
          default: true
        batch_size:
          type: integer
          default: 400
          description: æ¯æ¬¡è·å–çš„ä»£ç†æ•°é‡
        proxy_lifetime_minutes:
          type: integer
          default: 10
          description: ä»£ç†ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ†é’Ÿï¼‰
        rotation_interval_minutes:
          type: integer
          default: 7
          description: è½®æ¢é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        low_watermark:
          type: integer
          default: 50
          description: ä½æ°´ä½çº¿
        target_size:
          type: integer
          default: 200
          description: ç›®æ ‡æ± å¤§å°
        auto_start_enabled:
          type: boolean
          default: true
          description: è‡ªåŠ¨å¯åŠ¨å¼€å…³
        pre_market_start_minutes:
          type: integer
          default: 2
          description: ç›˜å‰å¯åŠ¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
        post_market_stop_minutes:
          type: integer
          default: 30
          description: ç›˜ååœæ­¢æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

    ConfigUpdateRequest:
      type: object
      properties:
        hailiang_api_url:
          type: string
        hailiang_enabled:
          type: boolean
        batch_size:
          type: integer
        proxy_lifetime_minutes:
          type: integer
        rotation_interval_minutes:
          type: integer
        low_watermark:
          type: integer
        target_size:
          type: integer
        auto_start_enabled:
          type: boolean
        pre_market_start_minutes:
          type: integer
        post_market_stop_minutes:
          type: integer

    ConfigUpdateResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, error]
        message:
          type: string
        config:
          $ref: '#/components/schemas/ProxyPoolConfig'

    # ç›‘æ§æ¨¡å‹
    AlertsResponse:
      type: object
      properties:
        alerts:
          type: array
          items:
            $ref: '#/components/schemas/Alert'
        total:
          type: integer
        filters:
          type: object
          properties:
            hours:
              type: integer
            level:
              type: string
            market:
              type: string

    Alert:
      type: object
      properties:
        id:
          type: string
        level:
          type: string
          enum: [info, warning, error, critical]
        title:
          type: string
        message:
          type: string
        market:
          type: string
          nullable: true
        component:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time
        acknowledged:
          type: boolean

    MonitoringSummaryResponse:
      type: object
      properties:
        alerts:
          type: object
          properties:
            total_alerts:
              type: integer
            last_24h:
              $ref: '#/components/schemas/AlertSummary'
            last_1h:
              $ref: '#/components/schemas/AlertSummary'
        health:
          type: object
          properties:
            thresholds:
              type: object
        timestamp:
          type: string
          format: date-time

    AlertSummary:
      type: object
      properties:
        total:
          type: integer
        critical:
          type: integer
        error:
          type: integer
        warning:
          type: integer
        info:
          type: integer

    # è°ƒåº¦å™¨æ¨¡å‹
    SchedulerStatusResponse:
      type: object
      properties:
        scheduler_running:
          type: boolean
        markets:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/MarketSchedule'

    MarketSchedule:
      type: object
      properties:
        next_start_time:
          type: string
          format: date-time
        next_stop_time:
          type: string
          format: date-time
        is_trading_day:
          type: boolean
        current_status:
          type: string
          enum: [running, stopped]

    # é€šç”¨æ¨¡å‹
    OperationResponse:
      type: object
      properties:
        status:
          type: string
          enum: [started, stopped, success, error]
        message:
          type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, partial, unhealthy]
        service:
          type: string
        version:
          type: string
        proxy_pools:
          type: object
          additionalProperties:
            type: boolean
        total_pools:
          type: integer
        running_pools:
          type: integer

    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          enum: [error]
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
        timestamp:
          type: string
          format: date-time